const dbName="FileDatabase",osName="files",chunkSize=1048576;let dbh,wss,fileinfo;const greeting="I am Alice!";let masterKey,state={sent_offset:0,confirmed_offset:0,offset_lists:[]};function getDocumentId(){return document.getElementById("uuid").textContent}function send_greeting(){const e=getDocumentId();wss.send(`${greeting}|${e}`)}function sendChunk(e){if(void 0===e)return void sendEOF();const t=dbh.transaction([osName],"readonly");t.onerror=function(e){errorMessageBox("Error","The read transaction error while sending the file!")};const n=t.objectStore(osName).get(e);n.onerror=function(e){errorMessageBox("Error","Error reading the file chunk from the local database!")},n.onsuccess=function(t){if(!n.result)return void sendEOF();const o=(new TextEncoder).encode(getDocumentId()),s=(new TextEncoder).encode("|data|"),r=new ArrayBuffer(4);new DataView(r).setUint32(0,e,!0);const i=new Uint8Array(n.result.data),a=new Uint8Array(o.length+s.length+r.byteLength+i.byteLength);a.set(o,0),a.set(s,o.length),a.set(new Uint8Array(r),o.length+s.length),a.set(i,o.length+s.length+4),wss.send(a),state.sent_offset=e,setBarWidth((e+i.byteLength)/fileinfo.size*100)}}function sendEOF(){wss.send(`${fileinfo.uuid}|EOF|`),setBarWidth(100),hideProgressBar()}function sendFile(){setBarWidth(0),showProgressBar(),setProgressTitle("Sending file..."),sendChunk(state.offset_lists.shift())}function onMessage(e,t){try{const e=JSON.parse(t);if(void 0!==e.result)switch(e.result){case"bob is ready":return void(e.id===getDocumentId()&&sendFile());case"OK":default:return;case"ERROR":return void errorMessageBox("Error",e.error);case"RCVD":return state.confirmed_offset=e.offset,void(state.sent_offset===state.confirmed_offset&&sendChunk(state.offset_lists.shift()))}}catch(e){return}}function open_ws(){return wss&&(wss.onerror=ws.onopen=ws.onclose=null,wss.close()),wss=new WebSocket(`ws://${location.host}`),wss.onerror=function(){errorMessageBox("Error","WebSocket error")},wss.onopen=function(){send_greeting()},wss.onclose=function(){wss=null},wss.onmessage=function(e){onMessage(wss,e.data)},wss}function delete_db(){indexedDB.deleteDatabase(dbName)}function open_db(){return dbh=indexedDB.open(dbName,1),dbh.onerror=function(e){errorMessageBox("Error","Error opening the local database. Please, reload the page to try again.")},dbh.onsuccess=function(e){dbh=e.target.result},dbh.onupgradeneeded=function(e){e.target.result.createObjectStore(osName,{keyPath:"id"})},dbh}function saveChunk(e,t){const n=new FileReader,o=e.slice(t,t+chunkSize);n.onload=function(n){const o=themis.encryptData(masterKey,new Uint8Array(n.target.result)),s=dbh.transaction([osName],"readwrite");s.onerror=function(e){errorMessageBox("Error","The transaction error while saving the file!")};const r=s.objectStore(osName).add({id:t,data:o});r.onerror=function(e){errorMessageBox("Error","Error saving the file chunk to the local database!")},r.onsuccess=function(n){if(state.offset_lists.push(t),t+=chunkSize,setBarWidth(t/fileinfo.size*100),t<e.size)saveChunk(e,t);else{let e=document.getElementById("receive_url").textContent.trim();e=e+"/"+document.getElementById("masterKey").textContent,document.getElementById("receive_url").textContent=e,document.getElementById("receive_url").style.display="block",hideProgressBar(),document.getElementById("encryption_key_table").style.display="none",document.getElementById("receive_url_table").style.display="block"}},s.commit()},n.readAsArrayBuffer(o)}function showFileInfo(){document.getElementById("fileInfo").style.display="block",document.getElementById("fileName").textContent=fileinfo.name,document.getElementById("fileSize").textContent=fileinfo.size}function sendFileInfo(){try{wss.send(`${fileinfo.uuid}|fileinfo|${JSON.stringify(fileinfo)}`)}catch(e){alert("Error sending file information to the recipient. The page will be reloaded. ")}}function uploadFile(e){const t=document.getElementById("fileInput");if(!t.files.length)return void alert("Please select a file to upload.");const n=t.files[0];if(n.size>4294967296)return void alert("Файл занадто великий для завантаження.");if(n.size<8)return void alert("Файл занадто малий для завантаження.");fileinfo={uuid:e,name:n.name,size:n.size},showFileInfo(),sendFileInfo();showProgressBar(),saveChunk(n,0),document.getElementById("fileInput").style.display="none",document.getElementById("upload_button").style.display="none"}function copyToClipboard(e){const t=document.getElementById(e).textContent;navigator.clipboard.writeText(t).then((()=>{alert("Copied to clipboard: "+t)})).catch((e=>{}))}document.addEventListener("DOMContentLoaded",(function(){delete_db(),dbh=open_db(),wss=open_ws(),setBarWidth(0),hideProgressBar(),themis.init().then((()=>{masterKey=themis.masterKey(),document.getElementById("masterKey").textContent=themis.uint8ArrayToHex(masterKey)}))}));