const dbName="FileDatabase",osName="files";let dbh,wss;const greeting="I am Bob!";let fileinfo;const chunkSize=1048576;let masterKey,state="loading";function getDocumentId(){return document.getElementById("uuid").textContent}function send_greeting(){const e=getDocumentId();wss.send(`${greeting}|${e}`)}function showFileInfo(){const e=document.createElement("h3");e.textContent=`${fileinfo.name} (${fileinfo.size} bytes)`,document.getElementById("fileInfo").replaceChildren(e)}function ready_to_receiveFile(e){wss.send(`${e}|ready|${fileinfo.name}`),showProgressBar()}function showSaveBtn(){hideProgressBar(),document.getElementById("saveFileBtn").style.display="inline-block",document.getElementById("receiveFileBtn").style.display="none",document.getElementById("encryption_key_table").style.display="none"}function onMessage(e,t){try{const e=JSON.parse(t);if(void 0!==e.result)switch(e.result){case"OK":return state="OK",fileinfo=e,void showFileInfo();case"EOF":return"ERROR"===state&&errorMessageBox("Error decrypting data","The key is invalid. Make sure you have the correct URL and try again."),state="EOF",void setTimeout(showSaveBtn,1e3);case"ERROR":return state="ERROR",void errorMessageBox("Error",e.error);default:return}}catch(e){t.slice(0,getDocumentId().length).text().then((e=>{if(e!==getDocumentId())return void errorMessageBox("Error","Invalid document id. Please, reload the page to try again.");t.slice(getDocumentId().length+6,getDocumentId().length+10).arrayBuffer().then((n=>{const o=new DataView(n).getUint32(0,!0);t.slice(getDocumentId().length+10).arrayBuffer().then((t=>{const n=new Uint8Array(t);try{saveChunk(themis.decryptData(masterKey,n),o),wss.send(`${e}|RCVD|${o}`)}catch(e){state="ERROR",errorMessageBox("Error decrypting data","The key is invalid. Make sure you have the correct URL and try again.")}}))}))}))}}function open_ws(){return wss&&(wss.onerror=ws.onopen=ws.onclose=null,wss.close()),wss=new WebSocket(`ws://${location.host}`),wss.onerror=function(){errorMessageBox("Error","WebSocket error. Please reload the page!")},wss.onopen=function(){send_greeting()},wss.onclose=function(){wss=null},wss.onmessage=function(e){onMessage(wss,e.data)},wss}function delete_db(){indexedDB.deleteDatabase(dbName)}function open_db(){return dbh=indexedDB.open(dbName,1),dbh.onerror=function(e){errorMessageBox("Error","Error opening the local database. Please, reload the page to try again.")},dbh.onsuccess=function(e){dbh=e.target.result},dbh.onupgradeneeded=function(e){e.target.result.createObjectStore(osName,{keyPath:"id"})},dbh}function saveChunk(e,t){const n=dbh.transaction([osName],"readwrite");n.onerror=function(e){errorMessageBox("Error","The transaction error occurred during saving file chunk to local database.")};n.objectStore(osName).add({id:t,data:e}).onerror=function(e){errorMessageBox("Error","Error saving the file chunk to the local database: "+e.target.error)},n.commit(),setBarWidth(t/fileinfo.size*100)}function saveFileToFS(){const e=dbh.transaction([osName],"readonly").objectStore(osName).openCursor();let t=[];setBarWidth(0),showProgressBar(),setProgressTitle("Saving file to your computer..."),e.onsuccess=function(e){const n=e.target.result;if(n)t.push(n.value.data),setBarWidth(n.value.id/fileinfo.size*100),n.continue();else{hideProgressBar();const e=new Blob(t,{type:"application/octet-stream"}),n=document.createElement("a");n.href=URL.createObjectURL(e),n.download=fileinfo.name,n.click()}}}document.addEventListener("DOMContentLoaded",(function(){delete_db(),dbh=open_db(),wss=open_ws(),hideProgressBar(),themis.init().then((()=>{const e=document.getElementById("masterKey").textContent;masterKey=themis.hexToUint8Array(e)}))}));